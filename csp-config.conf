# ============================================================================
# Content Security Policy (CSP) Configuration
# ============================================================================
#
# Este archivo define la política de seguridad de contenido para Entersys.
# Organizado por categorías para fácil mantenimiento y auditoría.
#
# Última actualización: 2025-11-01
# ============================================================================

# ----------------------------------------------------------------------------
# ANALYTICS & TRACKING
# ----------------------------------------------------------------------------
# Google Analytics 4, Facebook Pixel, Smartlook
set $csp_analytics_scripts "https://www.googletagmanager.com https://www.google-analytics.com https://analytics.entersys.mx https://connect.facebook.net https://web-sdk.smartlook.com";
set $csp_analytics_connect "https://www.google-analytics.com https://analytics.entersys.mx https://www.facebook.com https://*.smartlook.com https://*.smartlook.cloud";

# ----------------------------------------------------------------------------
# FORMS & INTEGRATIONS
# ----------------------------------------------------------------------------
# Smartsheet forms integration
set $csp_smartsheet "https://app.smartsheet.com https://*.smartsheet.com";

# ----------------------------------------------------------------------------
# CDN & EXTERNAL RESOURCES
# ----------------------------------------------------------------------------
# Cloudflare, Font Awesome, Google Fonts
set $csp_cdn_scripts "https://static.cloudflareinsights.com https://cdnjs.cloudflare.com";
set $csp_cdn_styles "https://fonts.googleapis.com https://cdnjs.cloudflare.com";
set $csp_cdn_fonts "https://fonts.gstatic.com https://cdnjs.cloudflare.com";
set $csp_cdn_connect "https://static.cloudflareinsights.com";

# ----------------------------------------------------------------------------
# MEDIA & EMBEDS
# ----------------------------------------------------------------------------
# YouTube embeds
set $csp_media_frames "https://www.youtube.com";

# ----------------------------------------------------------------------------
# API & BACKEND
# ----------------------------------------------------------------------------
# Entersys internal APIs
set $csp_api_connect "https://api.entersys.mx";

# ----------------------------------------------------------------------------
# CSP DIRECTIVES
# ----------------------------------------------------------------------------
# Política completa construida de forma modular

# default-src: Fallback para directivas no especificadas
set $csp_default "default-src 'self'";

# script-src: Scripts JavaScript permitidos
# NOTA: 'unsafe-inline' y 'unsafe-eval' requeridos por GTM y React en dev
# TODO: Migrar a nonces/hashes en producción para eliminar 'unsafe-*'
set $csp_scripts "script-src 'self' 'unsafe-inline' 'unsafe-eval' $csp_analytics_scripts $csp_smartsheet $csp_cdn_scripts";

# style-src: Hojas de estilo permitidas
# NOTA: 'unsafe-inline' requerido por componentes dinámicos de React
set $csp_styles "style-src 'self' 'unsafe-inline' $csp_smartsheet $csp_cdn_styles";

# img-src: Imágenes permitidas (amplio para CDNs y proxies)
set $csp_images "img-src 'self' data: https: blob:";

# font-src: Fuentes web permitidas
set $csp_fonts "font-src 'self' data: $csp_cdn_fonts";

# connect-src: Conexiones AJAX/fetch/WebSocket permitidas
set $csp_connect "connect-src 'self' $csp_analytics_connect $csp_smartsheet $csp_cdn_connect $csp_api_connect";

# frame-src: Iframes permitidos
set $csp_frames "frame-src 'self' $csp_media_frames $csp_smartsheet";

# object-src: Plugins (Flash, etc.) - bloqueados por seguridad
set $csp_objects "object-src 'none'";

# base-uri: URLs base permitidas - solo mismo origen
set $csp_base "base-uri 'self'";

# form-action: Destinos de formularios permitidos
set $csp_forms "form-action 'self' $csp_smartsheet";

# ----------------------------------------------------------------------------
# POLÍTICA COMPLETA
# ----------------------------------------------------------------------------
# Construcción de la política final combinando todas las directivas
set $content_security_policy "$csp_default; $csp_scripts; $csp_styles; $csp_images; $csp_fonts; $csp_connect; $csp_frames; $csp_objects; $csp_base; $csp_forms";
